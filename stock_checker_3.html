<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="color-scheme" content="dark"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>
  <meta name="theme-color" content="#060a0f"/>
<title>Leap Scanner</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow:wght@300;400;600;700;900&display=swap" rel="stylesheet"/>
<style>
  html, body {
    background-color: #0a0f1a !important;
  }

  :root {
    --bg: #0a0f1a;
    --surface: #111827;
    --border: #1e3a5f;
    --accent: #00cfff;
    --accent2: #00e676;
    --danger: #ff1744;
    --warn: #ffab00;
    --text: #e8f4fd;
    --muted: #5b8db8;
    --card: #0d1b2e;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Barlow', sans-serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    padding: 32px 20px 100px;
    overflow-x: hidden;
  }

  /* Grid background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0, 212, 255, 0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0, 212, 255, 0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .container {
    width: 100%;
    max-width: 680px;
    padding: 0 16px;
    box-sizing: border-box;
    position: relative;
    z-index: 1;
  }

  /* Header */
  .header {
    text-align: center;
    margin-bottom: 28px;
    padding-top: 0;
    width: 100%;
  }

  .header h1 {
    font-size: 64px !important;
    font-weight: 900 !important;
    letter-spacing: -2px;
    color: #00cfff !important;
    line-height: 1.05;
    margin-bottom: 0;
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    -webkit-text-fill-color: #00cfff;
  }

  .header-sub {
    font-size: 17px;
    color: var(--text);
    font-weight: 500;
    margin-bottom: 4px;
    opacity: 0.9;
  }

  .header-sub2 {
    font-size: 14px;
    color: var(--muted);
    font-weight: 400;
    margin-bottom: 0;
  }

  .search-hint {
    text-align: center;
    font-size: 13px;
    color: var(--muted);
    margin-top: 10px;
    margin-bottom: 24px;
    letter-spacing: 0.3px;
  }

  .header .label {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    letter-spacing: 4px;
    color: var(--accent);
    text-transform: uppercase;
    margin-bottom: 12px;
    opacity: 0.8;
  }

  .header h1 {
    font-size: 48px;
    font-weight: 900;
    letter-spacing: -2px;
    line-height: 1;
    background: linear-gradient(135deg, #fff 0%, var(--accent) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 12px;
  }

  .header p {
    color: var(--muted);
    font-size: 14px;
    font-weight: 300;
    letter-spacing: 0.5px;
  }

  /* Search */
  .search-wrap {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 24px;
    width: 100%;
  }

  .search-wrap input {
    width: 100%;
    box-sizing: border-box;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px 20px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 22px;
    font-weight: 700;
    letter-spacing: 4px;
    color: var(--accent);
    text-transform: uppercase;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .search-wrap input::placeholder {
    color: var(--muted);
    letter-spacing: 2px;
    font-size: 16px;
  }

  .search-wrap input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1), 0 0 20px rgba(0, 212, 255, 0.05);
  }

  .search-wrap button {
    background: var(--accent);
    color: var(--bg);
    border: none;
    border-radius: 12px;
    padding: 18px 28px;
    width: 100%;
    box-sizing: border-box;
    font-family: 'Barlow', sans-serif;
    font-size: 16px;
    font-weight: 700;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .search-wrap button:hover {
    background: #33ddff;
    transform: translateY(-1px);
    box-shadow: 0 8px 24px rgba(0, 212, 255, 0.3);
  }

  .search-wrap button:active { transform: translateY(0); }
  .search-wrap button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

  /* Stock info bar */
  .stock-info {
    display: flex;
    align-items: baseline;
    gap: 16px;
    margin-bottom: 24px;
    padding: 0 4px;
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.4s ease;
  }

  .stock-info.visible {
    opacity: 1;
    transform: translateY(0);
  }

  .stock-name {
    font-size: 28px;
    font-weight: 900;
    letter-spacing: -0.5px;
  }

  .stock-price {
    font-family: 'Share Tech Mono', monospace;
    font-size: 22px;
    color: var(--accent);
  }

  .stock-change {
    font-family: 'Share Tech Mono', monospace;
    font-size: 14px;
    padding: 3px 10px;
    border-radius: 4px;
  }

  .stock-change.up { background: rgba(0,255,136,0.15); color: var(--accent2); }
  .stock-change.down { background: rgba(255,61,87,0.15); color: var(--danger); }

  /* Score badge */
  .score-badge {
    margin-left: auto;
    font-family: 'Share Tech Mono', monospace;
    font-size: 13px;
    color: var(--muted);
  }

  .score-badge span {
    font-size: 20px;
    font-weight: 700;
    color: var(--text);
  }

  /* Cards */
  .checks {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .check-card {
    background: #0d1b2e;
    border: 1px solid #1e3a5f;
    border-radius: 12px;
    padding: 20px 24px;
    display: flex;
    align-items: center;
    gap: 20px;
    opacity: 0;
    transform: translateY(16px);
    transition: opacity 0.4s ease, transform 0.4s ease, border-color 0.3s;
    position: relative;
    overflow: hidden;
  }

  .check-card::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 3px;
    border-radius: 3px 0 0 3px;
    background: var(--border);
    transition: background 0.3s;
  }

  .check-card.visible { opacity: 1; transform: translateY(0); }

  .check-card.pass { border-color: rgba(0,255,136,0.2); }
  .check-card.pass::before { background: var(--accent2); }
  .check-card.fail { border-color: rgba(255,61,87,0.2); }
  .check-card.fail::before { background: var(--danger); }
  .check-card.loading { border-color: rgba(0,212,255,0.15); }

  /* Icon */
  .check-icon {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    flex-shrink: 0;
    transition: all 0.3s;
  }

  .check-icon.pass { 
    background: #1a4d3a;
    box-shadow: 0 0 0 2px #00e676, 0 0 20px rgba(0,230,118,0.4);
    border: 2px solid #00e676;
  }
  .check-icon.fail { 
    background: #3d1a1a;
    box-shadow: 0 0 0 2px #ff1744, 0 0 20px rgba(255,23,68,0.4);
    border: 2px solid #ff1744;
  }
  .check-icon.loading {
    background: rgba(0,212,255,0.08);
    animation: pulse 1.2s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 0.4; }
    50% { opacity: 1; }
  }

  /* Content */
  .check-content { flex: 1; }

  .check-title {
    font-size: 15px;
    font-weight: 600;
    letter-spacing: 0.3px;
    margin-bottom: 4px;
    color: var(--text);
  }

  .check-detail {
    font-family: 'Share Tech Mono', monospace;
    font-size: 12px;
    color: var(--muted);
    line-height: 1.6;
  }

  .check-detail .val {
    color: var(--accent);
  }

  .check-detail .pass-val { color: var(--accent2); }
  .check-detail .fail-val { color: var(--danger); }

  /* Status pill */
  .check-status {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    letter-spacing: 1px;
    padding: 5px 12px;
    border-radius: 20px;
    flex-shrink: 0;
    font-weight: 700;
  }

  .check-status.pass { background: rgba(0,255,136,0.12); color: var(--accent2); }
  .check-status.fail { background: rgba(255,61,87,0.12); color: var(--danger); }
  .check-status.loading { background: rgba(0,212,255,0.08); color: var(--muted); }

  /* Verdict */
  .verdict {
    margin-top: 24px;
    padding: 20px 24px;
    border-radius: 12px;
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 16px;
    opacity: 0;
    transform: translateY(16px);
    transition: all 0.5s ease 0.6s;
    background: var(--card);
  }

  .verdict.visible { opacity: 1; transform: translateY(0); }
  .verdict.bullish { border-color: rgba(0,255,136,0.3); background: rgba(0,255,136,0.04); }
  .verdict.bearish { border-color: rgba(255,61,87,0.3); background: rgba(255,61,87,0.04); }
  .verdict.neutral { border-color: rgba(255,184,0,0.3); background: rgba(255,184,0,0.04); }

  .verdict-icon { font-size: 28px; }

  .verdict-text .verdict-title {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 3px;
  }

  .verdict-text .verdict-sub {
    font-size: 13px;
    color: var(--muted);
    font-weight: 300;
  }

  .verdict.bullish .verdict-title { color: var(--accent2); }
  .verdict.bearish .verdict-title { color: var(--danger); }
  .verdict.neutral .verdict-title { color: var(--warn); }

  /* Error */
  .error-msg {
    text-align: center;
    padding: 24px;
    color: var(--danger);
    font-family: 'Share Tech Mono', monospace;
    font-size: 13px;
    display: none;
  }

  /* Fear & Greed Widget */
  .fg-widget {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 18px 20px;
    margin-bottom: 28px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.4s ease;
    width: 100%;
    box-sizing: border-box;
  }

  .fg-top-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .fg-title {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    letter-spacing: 2px;
    color: var(--muted);
    text-transform: uppercase;
  }

  .fg-widget.loaded { opacity: 1; transform: translateY(0); }

  .fg-label {
    font-family: 'Share Tech Mono', monospace;
    font-size: 8px;
    letter-spacing: 1.5px;
    color: var(--muted);
    text-transform: uppercase;
    flex-shrink: 0;
    writing-mode: vertical-rl;
    text-orientation: mixed;
    transform: rotate(180deg);
    line-height: 1.3;
    max-height: 80px;
  }



  .fg-bar-wrap {
    width: 100%;
    height: 14px;
    background: rgba(255,255,255,0.08);
    border-radius: 10px;
    overflow: visible;
    position: relative;
  }

  .fg-bar {
    height: 100%;
    border-radius: 8px;
    transition: width 1s ease;
    background: linear-gradient(90deg, #ff1744 0%, #ff6d00 25%, #ffab00 50%, #00e676 75%, #00cfff 100%);
    width: 100% !important;
    opacity: 0.95;
  }

  .fg-needle {
    position: absolute;
    top: -5px;
    width: 4px;
    height: 22px;
    background: white;
    border-radius: 3px;
    transform: translateX(-50%);
    transition: left 1s ease;
    box-shadow: 0 0 8px rgba(255,255,255,0.9);
  }

  .fg-axis-labels {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 2px;
  }

  .fg-axis-left {
    font-size: 11px;
    color: #ff1744;
    font-weight: 700;
    letter-spacing: 0.3px;
  }

  .fg-axis-right {
    font-size: 11px;
    color: #00cfff;
    font-weight: 700;
    letter-spacing: 0.3px;
  }

  .fg-right {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
  }

  .fg-score {
    font-family: 'Share Tech Mono', monospace;
    font-size: 26px;
    font-weight: 700;
    line-height: 1;
  }

  .fg-sentiment {
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
    padding: 4px 10px;
    border-radius: 20px;
    white-space: nowrap;
  }

  .fg-sentiment.extreme-fear  { background: rgba(255,61,87,0.15);   color: #ff3d57; }
  .fg-sentiment.fear          { background: rgba(255,140,0,0.15);   color: #ff8c00; }
  .fg-sentiment.neutral       { background: rgba(255,184,0,0.15);   color: #ffb800; }
  .fg-sentiment.greed         { background: rgba(100,220,100,0.15); color: #64dc64; }
  .fg-sentiment.extreme-greed { background: rgba(0,255,136,0.15);   color: #00ff88; }

  /* Twitter Buttons */
  .twitter-btns {
    display: flex !important;
    gap: 10px;
    margin-top: 16px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .tw-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-decoration: none;
    transition: all 0.2s;
    border: 1px solid var(--border);
  }

  .tw-share {
    background: rgba(29,161,242,0.12);
    color: #1da1f2;
    border-color: rgba(29,161,242,0.3);
  }

  .tw-search {
    background: rgba(0,212,255,0.08);
    color: var(--accent);
    border-color: rgba(0,212,255,0.2);
  }

  .tw-btn:hover { transform: translateY(-2px); opacity: 0.85; }

  /* Bottom Nav */
  .bottom-nav {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background: rgba(6,10,15,0.95);
    backdrop-filter: blur(12px);
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: space-around;
    padding: 8px 0 12px;
    z-index: 100;
  }

  .nav-btn {
    background: none;
    border: none;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 6px 24px;
    border-radius: 8px;
    transition: all 0.2s;
    color: var(--muted);
  }

  .nav-btn.active { color: var(--accent); }
  .nav-btn:hover  { color: var(--text); }

  .nav-icon  { font-size: 20px; }
  .nav-label { font-size: 10px; letter-spacing: 1px; text-transform: uppercase; font-weight: 600; }

  /* Tab panels */
  .tab-panel { padding-bottom: 80px; }

  .tab-title {
    font-size: 24px;
    font-weight: 900;
    letter-spacing: -0.5px;
    margin-bottom: 24px;
    color: var(--text);
  }

  /* Watchlist */
  .watchlist-empty { text-align: center; padding: 60px 20px; color: var(--muted); }

  .watchlist-item {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    transition: border-color 0.2s;
  }

  .watchlist-item:hover { border-color: var(--accent); }

  .wl-left { display: flex; align-items: center; gap: 14px; }
  .wl-ticker { font-size: 18px; font-weight: 900; letter-spacing: -0.5px; }
  .wl-price  { font-family: 'Share Tech Mono', monospace; font-size: 14px; color: var(--accent); }
  .wl-score  { font-family: 'Share Tech Mono', monospace; font-size: 12px; padding: 3px 10px; border-radius: 20px; }
  .wl-score.high { background: rgba(0,255,136,0.12); color: var(--accent2); }
  .wl-score.mid  { background: rgba(255,184,0,0.12);  color: var(--warn); }
  .wl-score.low  { background: rgba(255,61,87,0.12);  color: var(--danger); }
  .wl-remove { background: none; border: none; cursor: pointer; color: var(--muted); font-size: 16px; padding: 4px; }
  .wl-remove:hover { color: var(--danger); }
  .wl-bell { background: none; border: none; cursor: pointer; font-size: 16px; padding: 4px; opacity: 0.5; transition: opacity 0.2s; }
  .wl-bell:hover { opacity: 1; }
  .wl-bell.bell-on { opacity: 1; }
  .profile-fields { display: flex; flex-direction: column; gap: 14px; }
  .profile-field-group { display: flex; flex-direction: column; gap: 6px; }
  .field-label { font-size: 11px; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); font-family: 'Share Tech Mono', monospace; }
  .field-note  { font-size: 11px; color: var(--warn); margin-top: 4px; }

  .add-watchlist-btn {
    width: 100%;
    margin-top: 16px;
    padding: 12px;
    background: rgba(0,212,255,0.08);
    border: 1px solid rgba(0,212,255,0.2);
    border-radius: 8px;
    color: var(--accent);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    letter-spacing: 0.5px;
    transition: all 0.2s;
    display: none;
  }

  .add-watchlist-btn:hover { background: rgba(0,212,255,0.15); }

  /* Profile */
  .profile-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 32px;
    text-align: center;
    margin-bottom: 20px;
  }

  .profile-avatar { font-size: 48px; margin-bottom: 12px; }
  .profile-name   { font-size: 22px; font-weight: 900; letter-spacing: -0.5px; }
  .profile-sub    { font-size: 12px; color: var(--muted); letter-spacing: 1px; margin-top: 4px; font-family: 'Share Tech Mono', monospace; }

  .profile-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }

  .stat-box {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px 12px;
    text-align: center;
  }

  .stat-val { font-size: 28px; font-weight: 900; color: var(--accent); font-family: 'Share Tech Mono', monospace; }
  .stat-lbl { font-size: 10px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; margin-top: 4px; }

  .profile-edit { display: flex; gap: 10px; }

  .name-input {
    flex: 1;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 16px;
    color: var(--text);
    font-size: 14px;
    outline: none;
  }

  .name-input:focus { border-color: var(--accent); }

  .save-btn {
    background: var(--accent);
    color: var(--bg);
    border: none;
    border-radius: 8px;
    padding: 12px 20px;
    font-weight: 700;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .save-btn:hover { opacity: 0.85; }

  body { padding-bottom: 80px; }

  /* Alert Badge */
  .alert-badge {
    font-size: 10px;
    font-family: 'Share Tech Mono', monospace;
    color: var(--accent);
    background: rgba(0,212,255,0.12);
    border: 1px solid rgba(0,212,255,0.25);
    border-radius: 10px;
    padding: 2px 7px;
    font-weight: 700;
    flex-shrink: 0;
  }

  /* Modal */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.75);
    backdrop-filter: blur(4px);
    z-index: 200;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .modal-box {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px 24px;
    width: 100%;
    max-width: 360px;
    text-align: center;
  }

  .modal-title {
    font-size: 18px;
    font-weight: 800;
    margin-bottom: 8px;
    letter-spacing: -0.3px;
  }

  .modal-sub {
    font-size: 13px;
    color: var(--muted);
    margin-bottom: 20px;
    line-height: 1.5;
  }

  .alert-options {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 14px;
  }

  .alert-option {
    background: var(--surface);
    border: 2px solid var(--border);
    border-radius: 12px;
    padding: 16px 12px;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    transition: all 0.2s;
    color: var(--text);
  }

  .alert-option:hover, .alert-option.selected {
    border-color: var(--accent);
    background: rgba(0,212,255,0.08);
  }

  .alert-opt-score {
    font-size: 24px;
    font-weight: 900;
    font-family: 'Share Tech Mono', monospace;
    color: var(--accent);
  }

  .alert-opt-label {
    font-size: 11px;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--muted);
  }

  .alert-off-btn {
    width: 100%;
    padding: 10px;
    background: rgba(255,61,87,0.08);
    border: 1px solid rgba(255,61,87,0.2);
    border-radius: 8px;
    color: #ff3d57;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    margin-bottom: 10px;
    transition: all 0.2s;
  }

  .alert-off-btn:hover { background: rgba(255,61,87,0.15); }

  .modal-close {
    width: 100%;
    padding: 10px;
    background: none;
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--muted);
    font-size: 13px;
    cursor: pointer;
    margin-bottom: 12px;
    transition: all 0.2s;
  }

  .modal-close:hover { color: var(--text); border-color: var(--text); }

  .modal-note {
    font-size: 11px;
    color: var(--warn);
    line-height: 1.4;
  }

  /* Toast */
  #toast {
    position: fixed;
    bottom: 90px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--card);
    border: 1px solid var(--accent);
    color: var(--text);
    padding: 12px 20px;
    border-radius: 30px;
    font-size: 13px;
    font-weight: 600;
    opacity: 0;
    transition: all 0.3s ease;
    white-space: nowrap;
    z-index: 300;
    pointer-events: none;
  }

  #toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  /* Footer */
  .footer {
    margin-top: 40px;
    text-align: center;
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 0.5px;
    font-family: 'Share Tech Mono', monospace;
  }

  /* Spinner in button */
  .spinner {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid rgba(6,10,15,0.3);
    border-top-color: var(--bg);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    vertical-align: middle;
    margin-right: 6px;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* ‚îÄ‚îÄ Options Chain Tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .tab-subtitle {
    color: var(--muted);
    font-size: 13px;
    margin-top: -8px;
    margin-bottom: 20px;
  }

  .opt-search-wrap {
    display: flex;
    flex-direction: column;
    gap: 0;
    margin-bottom: 20px;
    width: 100%;
  }

  .opt-search-wrap input {
    width: 100%;
    box-sizing: border-box;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px 20px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 20px;
    font-weight: 700;
    letter-spacing: 4px;
    color: var(--accent);
    text-transform: uppercase;
    outline: none;
    transition: border-color 0.2s;
  }

  .opt-search-wrap input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(0,207,255,0.1);
  }

  .opt-exp-wrap {
    margin-bottom: 16px;
  }

  .opt-select {
    width: 100%;
    box-sizing: border-box;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 16px;
    color: var(--text);
    font-size: 14px;
    font-family: 'Share Tech Mono', monospace;
    outline: none;
    margin-top: 6px;
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%235b8db8' stroke-width='2' fill='none'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 14px center;
  }

  .opt-toggle-wrap {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
  }

  .opt-toggle {
    flex: 1;
    padding: 12px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--muted);
    font-family: 'Barlow', sans-serif;
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
  }

  .opt-toggle.active {
    background: var(--accent);
    color: var(--bg);
    border-color: var(--accent);
    box-shadow: 0 0 16px rgba(0,207,255,0.3);
  }

  .opt-price-bar {
    display: flex;
    align-items: center;
    gap: 12px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 16px;
    margin-bottom: 14px;
    font-size: 14px;
    flex-wrap: wrap;
  }

  .opt-price-val {
    font-family: 'Share Tech Mono', monospace;
    font-size: 16px;
    font-weight: 700;
    color: var(--accent2);
    flex: 1;
  }

  .opt-itm-key {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 12px;
    color: var(--muted);
  }

  .itm-dot {
    width: 10px; height: 10px;
    border-radius: 2px;
    background: rgba(0,230,118,0.25);
    border: 1px solid #00e676;
    display: inline-block;
  }

  .otm-dot {
    width: 10px; height: 10px;
    border-radius: 2px;
    background: var(--surface);
    border: 1px solid var(--border);
    display: inline-block;
  }

  .opt-table-wrap {
    width: 100%;
    margin-bottom: 16px;
  }

  .opt-table-scroll {
    overflow-x: auto;
    border-radius: 12px;
    border: 1px solid var(--border);
  }

  .opt-table {
    width: 100%;
    border-collapse: collapse;
    font-family: 'Share Tech Mono', monospace;
    font-size: 12px;
    min-width: 520px;
  }

  .opt-table thead th {
    background: var(--surface);
    color: var(--muted);
    font-size: 10px;
    letter-spacing: 1px;
    text-transform: uppercase;
    padding: 10px 10px;
    text-align: right;
    white-space: nowrap;
    border-bottom: 1px solid var(--border);
  }

  .opt-table thead th:first-child { text-align: left; }

  .opt-table tbody tr {
    border-bottom: 1px solid rgba(30,58,95,0.5);
    transition: background 0.15s;
  }

  .opt-table tbody tr:hover { background: rgba(0,207,255,0.04); }
  .opt-table tbody tr:last-child { border-bottom: none; }

  .opt-table tbody td {
    padding: 10px 10px;
    text-align: right;
    color: var(--text);
    white-space: nowrap;
  }

  .opt-table tbody td:first-child { text-align: left; font-weight: 700; }

  /* ITM row highlight */
  .opt-table tbody tr.itm-row {
    background: rgba(0,230,118,0.07);
  }
  .opt-table tbody tr.itm-row td:first-child {
    color: #00e676;
  }

  /* Strike cell */
  .strike-cell {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .itm-badge {
    font-size: 9px;
    background: rgba(0,230,118,0.2);
    color: #00e676;
    border: 1px solid #00e676;
    border-radius: 3px;
    padding: 1px 4px;
    letter-spacing: 0.5px;
  }

  /* Greeks colors */
  .delta-high { color: #00e676; }
  .delta-mid  { color: var(--warn); }
  .delta-low  { color: var(--muted); }
  .theta-val  { color: #ff6b6b; }
  .iv-val     { color: var(--warn); }

  /* Loading spinner */
  .opt-loading {
    text-align: center;
    padding: 40px 20px;
  }

  .opt-spinner {
    width: 36px; height: 36px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* 4-tab nav ‚Äî shrink padding */
  .bottom-nav .nav-btn { padding: 6px 14px; }

</style>
</head>
<body>

<div class="container">

  <div class="header">
    <h1 style="font-size:64px!important;font-weight:900!important;color:#00cfff!important;-webkit-text-fill-color:#00cfff!important;letter-spacing:-2px;line-height:1.05;display:block!important;">Leap Scanner</h1>
  </div>

  <!-- Fear & Greed Widget -->
  <!-- Scanner Page Wrapper -->
  <div id="scannerPage">
  <div class="fg-widget" id="fgWidget">
    <div class="fg-top-row">
      <span class="fg-title">Market Sentiment</span>
      <div class="fg-right">
        <div class="fg-score" id="fgScore">--</div>
        <div class="fg-sentiment" id="fgSentiment">Loading...</div>
      </div>
    </div>
    <div class="fg-bar-wrap">
      <div class="fg-bar" id="fgBar" style="width:0%"></div>
      <div class="fg-needle" id="fgNeedle" style="left:0%"></div>
    </div>
    <div class="fg-axis-labels">
      <span class="fg-axis-left">üìà Great time to buy</span>
      <span class="fg-axis-right">üí∞ Stack cash</span>
    </div>
  </div>

  <div class="search-wrap" style="display:flex!important;flex-direction:column!important;width:100%!important;gap:12px;">
    <input type="text" id="tickerInput" placeholder="Apple, Microsoft, or AAPL..." maxlength="50"/>
    <button id="analyzeBtn" onclick="analyze()">Analyze</button>
  </div>

  <div class="error-msg" id="errorMsg"></div>

  <div class="stock-info" id="stockInfo">
    <div class="stock-name" id="stockName"></div>
    <div class="stock-price" id="stockPrice"></div>
    <div class="stock-change" id="stockChange"></div>
    <div class="score-badge">Score: <span id="scoreVal">‚Äî</span>/4</div>
  </div>

  <div class="checks" id="checksContainer"></div>
  <div class="verdict" id="verdict">
    <div class="verdict-icon" id="verdictIcon"></div>
    <div class="verdict-text">
      <div class="verdict-title" id="verdictTitle"></div>
      <div class="verdict-sub" id="verdictSub"></div>
    </div>
  </div>

  <!-- Twitter Buttons -->
  <div class="twitter-btns" id="twitterBtns" style="display:none; margin-top:16px; gap:10px; display:none; flex-direction:row; justify-content:center;">
    <a id="tweetShareBtn" href="#" target="_blank" class="tw-btn tw-share">üê¶ Tweet This Analysis</a>
    <a id="tweetSearchBtn" href="#" target="_blank" class="tw-btn tw-search">üîç View $TICKER on X</a>
  </div>
  </div> <!-- end scannerPage -->


  <!-- Alert Threshold Modal -->
  <div id="alertModal" style="display:none;" class="modal-overlay" onclick="if(event.target===this)closeAlertModal()">
    <div class="modal-box">
      <div class="modal-title">Set Alert for <span id="alertModalTicker" style="color:var(--accent)"></span></div>
      <p class="modal-sub">Notify me when this stock reaches a Leap Scanner score of:</p>
      <div class="alert-options">
        <button class="alert-option" data-val="3" onclick="setAlertThreshold('3')">
          <span class="alert-opt-score">3/4</span>
          <span class="alert-opt-label">Strong Setup</span>
        </button>
        <button class="alert-option" data-val="4" onclick="setAlertThreshold('4')">
          <span class="alert-opt-score">4/4</span>
          <span class="alert-opt-label">Strongest Setup</span>
        </button>
      </div>
      <button class="alert-off-btn" onclick="setAlertThreshold('off')">üîï Remove Alert</button>
      <button class="modal-close" onclick="closeAlertModal()">Cancel</button>
      <p class="modal-note">‚ö†Ô∏è Push notifications coming soon ‚Äî alerts will show in-app for now</p>
    </div>
  </div>

  <!-- Bottom Nav -->
  <nav class="bottom-nav">
    <button class="nav-btn active" onclick="showTab('home')" id="nav-home">
      <span class="nav-icon">üìä</span>
      <span class="nav-label">Scanner</span>
    </button>
    <button class="nav-btn" onclick="showTab('watchlist')" id="nav-watchlist">
      <span class="nav-icon">‚≠ê</span>
      <span class="nav-label">Watchlist</span>
    </button>
    <button class="nav-btn" onclick="showTab('profile')" id="nav-profile">
      <span class="nav-icon">üë§</span>
      <span class="nav-label">Profile</span>
    </button>
    <button class="nav-btn" onclick="showTab('options')" id="nav-options">
      <span class="nav-icon">üîó</span>
      <span class="nav-label">Options</span>
    </button>
  </nav>

  <!-- Watchlist Tab -->
  <div class="tab-panel" id="tab-watchlist" style="display:none;">
    <h2 class="tab-title">Watchlist</h2>
    <div class="watchlist-empty" id="watchlistEmpty">
      <div style="font-size:40px; margin-bottom:12px;">‚≠ê</div>
      <p>Your watchlist is empty.</p>
      <p style="color:var(--muted); font-size:13px; margin-top:6px;">Analyze a stock and click "Add to Watchlist" to save it here.</p>
    </div>
    <div id="watchlistItems"></div>
    <div class="footer" style="margin-top:32px;">Data via Yahoo Finance ¬∑ FMP ¬∑ CNN ¬∑ For educational purposes only ¬∑ Not financial advice</div>
  </div>

  <!-- Profile Tab -->
  <div class="tab-panel" id="tab-profile" style="display:none;">
    <h2 class="tab-title">Profile</h2>
    <div class="profile-card">
      <div class="profile-avatar">üë§</div>
      <div class="profile-name" id="profileName">Investor</div>
      <div class="profile-sub">LeapScreener Member</div>
    </div>
    <div class="profile-stats">
      <div class="stat-box">
        <div class="stat-val" id="statScanned">0</div>
        <div class="stat-lbl">Stocks Scanned</div>
      </div>
      <div class="stat-box">
        <div class="stat-val" id="statWatchlist">0</div>
        <div class="stat-lbl">Watchlist</div>
      </div>
      <div class="stat-box">
        <div class="stat-val" id="statPassed">0</div>
        <div class="stat-lbl">Passed 3+/4</div>
      </div>
    </div>
    <div class="profile-fields">
      <div class="profile-field-group">
        <label class="field-label">Username</label>
        <input type="text" id="nameInput" placeholder="Enter username..." class="name-input"/>
      </div>
      <div class="profile-field-group">
        <label class="field-label">Email</label>
        <input type="email" id="emailInput" placeholder="Enter email..." class="name-input"/>
      </div>
      <div class="profile-field-group">
        <label class="field-label">Password</label>
        <input type="password" id="passInput" placeholder="Set password..." class="name-input"/>
        <span class="field-note">‚ö†Ô∏è Saved locally only ‚Äî full auth coming soon</span>
      </div>
      <button onclick="saveProfile()" class="save-btn" style="width:100%;margin-top:8px;">Save Profile</button>
    </div>
    <div class="footer" style="margin-top:32px;">Data via Yahoo Finance ¬∑ FMP ¬∑ CNN ¬∑ For educational purposes only ¬∑ Not financial advice</div>
  </div>

  <!-- Options Chain Tab -->
  <div class="tab-panel" id="tab-options" style="display:none;">
    <h2 class="tab-title">Options Chain</h2>
    <p class="tab-subtitle">View calls &amp; puts with Greeks for any ticker</p>

    <div class="opt-search-wrap">
      <input type="text" id="optTickerInput" placeholder="AAPL, MSFT, NVDA..." maxlength="10" oninput="this.value=this.value.toUpperCase()"/>
      <button onclick="loadOptionsChain()" class="save-btn" style="margin-top:10px;width:100%;">Load Chain</button>
    </div>

    <div class="opt-exp-wrap" id="optExpWrap" style="display:none;">
      <label class="field-label">Expiration Date</label>
      <select id="optExpSelect" onchange="loadStrikesByExp()" class="opt-select"></select>
    </div>

    <div class="opt-toggle-wrap" id="optToggleWrap" style="display:none;">
      <button class="opt-toggle active" id="toggleCalls" onclick="switchSide('calls')">Calls</button>
      <button class="opt-toggle" id="togglePuts" onclick="switchSide('puts')">Puts</button>
    </div>

    <div class="opt-price-bar" id="optPriceBar" style="display:none;">
      <span id="optStockLabel" style="font-weight:700;font-size:15px;"></span>
      <span class="opt-price-val" id="optStockPrice"></span>
      <span class="opt-itm-key"><span class="itm-dot"></span> ITM</span>
      <span class="opt-itm-key"><span class="otm-dot"></span> OTM</span>
    </div>

    <div class="opt-table-wrap" id="optTableWrap" style="display:none;">
      <div class="opt-table-scroll">
        <table class="opt-table" id="optTable">
          <thead>
            <tr>
              <th>Strike</th><th>Last</th><th>Bid</th><th>Ask</th>
              <th>Vol</th><th>OI</th><th>IV %</th><th>Delta</th><th>Theta</th>
            </tr>
          </thead>
          <tbody id="optTableBody"></tbody>
        </table>
      </div>
    </div>

    <div class="opt-loading" id="optLoading" style="display:none;">
      <div class="opt-spinner"></div>
      <p style="color:var(--muted);margin-top:12px;">Fetching options data...</p>
    </div>
    <div id="optError" style="display:none;color:var(--danger);padding:16px;text-align:center;font-size:14px;"></div>

    <div class="footer" style="margin-top:32px;">Options data via Tradier ¬∑ Delayed 15 min ¬∑ Not financial advice</div>
  </div>

</div>

<script>
const CHECKS = [
  {
    id: 'ma200d',
    title: 'At or Below 200-Day Moving Average',
    desc: 'Price ‚â§ 200-day MA suggests potential undervaluation or oversold conditions'
  },
  {
    id: 'rsi30',
    title: 'RSI At or Below 30 (Oversold)',
    desc: 'RSI ‚â§ 30 indicates the stock may be oversold and due for a bounce'
  },
  {
    id: 'balance',
    title: 'Healthy Balance Sheet',
    desc: 'Growing profit margins + enough cash to cover total debt'
  },
  {
    id: 'ma200w',
    title: 'At or Below 200-Week Moving Average',
    desc: 'Long-term technical support ‚Äî historically strong buy zones'
  }
];

function renderSkeletons() {
  const container = document.getElementById('checksContainer');
  container.innerHTML = '';
  CHECKS.forEach((c, i) => {
    const card = document.createElement('div');
    card.className = 'check-card loading';
    card.id = `card-${c.id}`;
    card.innerHTML = `
      <div class="check-icon loading">‚ü≥</div>
      <div class="check-content">
        <div class="check-title">${c.title}</div>
        <div class="check-detail">Fetching data...</div>
      </div>
      <div class="check-status loading">LOADING</div>
    `;
    container.appendChild(card);
    setTimeout(() => card.classList.add('visible'), 80 * i);
  });
}

function updateCard(id, pass, detail) {
  const card = document.getElementById(`card-${id}`);
  if (!card) return;
  card.className = `check-card ${pass ? 'pass' : 'fail'} visible`;
  const check = CHECKS.find(c => c.id === id);
  card.innerHTML = `
    <div class="check-icon ${pass ? 'pass' : 'fail'}">${pass ? '‚úì' : '‚úó'}</div>
    <div class="check-content">
      <div class="check-title">${check.title}</div>
      <div class="check-detail">${detail}</div>
    </div>
    <div class="check-status ${pass ? 'pass' : 'fail'}">${pass ? 'PASS' : 'FAIL'}</div>
  `;
}

function showError(msg) {
  const el = document.getElementById('errorMsg');
  el.textContent = msg;
  el.style.display = 'block';
}

function hideError() {
  document.getElementById('errorMsg').style.display = 'none';
}

const PROXY = 'https://corsproxy.io/?';

async function loadFearGreed() {
  try {
    const url = PROXY + encodeURIComponent('https://production.dataviz.cnn.io/index/fearandgreed/graphdata');
    const res  = await fetch(url);
    const data = await res.json();
    const score = Math.round(data?.fear_and_greed?.score || data?.score || 50);
    let sentiment, cls;
    if      (score <= 25) { sentiment = 'Extreme Fear';  cls = 'extreme-fear';  }
    else if (score <= 45) { sentiment = 'Fear';          cls = 'fear';          }
    else if (score <= 55) { sentiment = 'Neutral';       cls = 'neutral';       }
    else if (score <= 75) { sentiment = 'Greed';         cls = 'greed';         }
    else                  { sentiment = 'Extreme Greed'; cls = 'extreme-greed'; }

    document.getElementById('fgScore').textContent     = score;
    document.getElementById('fgSentiment').textContent = sentiment;
    document.getElementById('fgSentiment').className   = `fg-sentiment ${cls}`;
    document.getElementById('fgBar').style.width       = `100%`;
    document.getElementById('fgNeedle').style.left     = `${score}%`;

    // Color the score number
    const colors = { 'extreme-fear': '#ff3d57', 'fear': '#ff8c00', 'neutral': '#ffb800', 'greed': '#64dc64', 'extreme-greed': '#00ff88' };
    document.getElementById('fgScore').style.color = colors[cls];
    document.getElementById('fgWidget').classList.add('loaded');
  } catch(e) {
    document.getElementById('fgSentiment').textContent = 'Unavailable';
    document.getElementById('fgWidget').classList.add('loaded');
  }
}

// Load fear & greed on page load
window.addEventListener('load', loadFearGreed);
const FMP_KEY     = 'xVUPjSjRHiSCpoQZd3itcYudPFzolisd';
const TRADIER_KEY = 'GeYR0e9BgC2ODN2LFZBvscfFMh70';
const AV_KEY      = 'OEITKB7QOV6KPC7T'; // Alpha Vantage fallback

async function fetchYahoo(ticker) {
  const url = PROXY + encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=1y`);
  const chartRes = await fetch(url);
  const chart = await chartRes.json();

  return { chart, summary: null };
}

async function fetchFMPFundamentals(ticker) {
  try {
    const incomeUrl = `https://financialmodelingprep.com/stable/income-statement?symbol=${ticker}&period=annual&limit=4&apikey=${FMP_KEY}`;
    const bsUrl     = `https://financialmodelingprep.com/stable/balance-sheet-statement?symbol=${ticker}&period=annual&limit=2&apikey=${FMP_KEY}`;

    const [iRes, bRes] = await Promise.all([fetch(incomeUrl), fetch(bsUrl)]);
    const iRaw = await iRes.json();
    const bRaw = await bRes.json();

    console.log('FMP income:', JSON.stringify(iRaw).substring(0, 300));
    console.log('FMP bs:', JSON.stringify(bRaw).substring(0, 300));

    // Extract array from whatever format FMP returns
    const income = Array.isArray(iRaw) ? iRaw
                 : Array.isArray(iRaw?.data) ? iRaw.data : [];
    const bs     = Array.isArray(bRaw) ? bRaw
                 : Array.isArray(bRaw?.data) ? bRaw.data : [];

    if (income.length > 0 && bs.length > 0) {
      return { income, bs, source: 'FMP' };
    }

    // Try quarterly as fallback for non-standard fiscal years
    const incomeQUrl = `https://financialmodelingprep.com/stable/income-statement?symbol=${ticker}&period=quarter&limit=8&apikey=${FMP_KEY}`;
    const bsQUrl     = `https://financialmodelingprep.com/stable/balance-sheet-statement?symbol=${ticker}&period=quarter&limit=4&apikey=${FMP_KEY}`;

    const [iQRes, bQRes] = await Promise.all([fetch(incomeQUrl), fetch(bsQUrl)]);
    const iQRaw = await iQRes.json();
    const bQRaw = await bQRes.json();

    const incomeQ = Array.isArray(iQRaw) ? iQRaw : Array.isArray(iQRaw?.data) ? iQRaw.data : [];
    const bsQ     = Array.isArray(bQRaw) ? bQRaw : Array.isArray(bQRaw?.data) ? bQRaw.data : [];

    if (incomeQ.length >= 4) {
      // Aggregate last 4 quarters into TTM
      const qtrs = incomeQ.slice(0, 4);
      const sum  = f => qtrs.reduce((s, q) => s + (parseFloat(q[f]) || 0), 0);
      const ttm  = { revenue: sum('revenue'), netIncome: sum('netIncome'), date: qtrs[0]?.date };
      const prev = incomeQ.length >= 8 ? {
        revenue: incomeQ.slice(4, 8).reduce((s, q) => s + (parseFloat(q.revenue) || 0), 0)
      } : null;
      return {
        income: [ttm, prev].filter(Boolean),
        bs:     bsQ,
        source: 'FMP (TTM)'
      };
    }

    // Last resort: Alpha Vantage
    console.log('FMP empty, trying Alpha Vantage...');
    const avIncome = PROXY + encodeURIComponent(`https://www.alphavantage.co/query?function=INCOME_STATEMENT&symbol=${ticker}&apikey=${AV_KEY}`);
    const avBS     = PROXY + encodeURIComponent(`https://www.alphavantage.co/query?function=BALANCE_SHEET&symbol=${ticker}&apikey=${AV_KEY}`);
    const [avIRes, avBRes] = await Promise.all([fetch(avIncome), fetch(avBS)]);
    const avI = await avIRes.json();
    const avB = await avBRes.json();

    const avInc = (avI?.annualReports || []).slice(0, 2).map(r => ({
      revenue:   parseFloat(r.totalRevenue) || 0,
      netIncome: parseFloat(r.netIncome)    || 0,
      date:      r.fiscalDateEnding
    }));
    const avBs = (avB?.annualReports || []).slice(0, 1).map(r => ({
      cashAndCashEquivalents: parseFloat(r.cashAndCashEquivalentsAtCarryingValue) || 0,
      shortTermInvestments:   parseFloat(r.shortTermInvestments) || 0,
      totalDebt: (parseFloat(r.shortLongTermDebtTotal) || 0) ||
                 ((parseFloat(r.longTermDebt) || 0) + (parseFloat(r.shortTermDebt) || 0))
    }));

    if (avInc.length > 0) {
      console.log('Alpha Vantage success');
      return { income: avInc, bs: avBs, source: 'Alpha Vantage' };
    }

    return { income: [], bs: [], source: null };

  } catch(e) {
    console.error('fetchFMPFundamentals error:', e);
    return { income: [], bs: [], source: null };
  }
}


async function fetchWeeklyChart(ticker) {
  const url = PROXY + encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1wk&range=5y`);
  const res = await fetch(url);
  return res.json();
}

function calcSMA(prices, period) {
  if (prices.length < period) return null;
  const slice = prices.slice(-period);
  return slice.reduce((a, b) => a + b, 0) / period;
}

function calcRSI(prices, period = 14) {
  if (prices.length < period + 1) return null;
  const changes = [];
  for (let i = 1; i < prices.length; i++) {
    changes.push(prices[i] - prices[i - 1]);
  }
  const recent = changes.slice(-period);
  const gains = recent.filter(c => c > 0);
  const losses = recent.filter(c => c < 0).map(c => Math.abs(c));
  const avgGain = gains.length ? gains.reduce((a, b) => a + b, 0) / period : 0;
  const avgLoss = losses.length ? losses.reduce((a, b) => a + b, 0) / period : 0;
  if (avgLoss === 0) return 100;
  const rs = avgGain / avgLoss;
  return 100 - (100 / (1 + rs));
}

async function analyze() {
  const input  = document.getElementById('tickerInput');
  const raw    = input.value.trim();
  if (!raw) return;

  hideError();

  // Resolve company name ‚Üí ticker
  // Real tickers are 1-4 chars (AAPL, MSFT, NVDA) or known 5-char ones (GOOGL, META was 4)
  // If user types a word like "Apple" or "APPLE" we search FMP to resolve it
  const upperRaw = raw.toUpperCase();
  // Only treat as direct ticker if: all caps, max 4 chars, no spaces
  // 5-char inputs always go through search to catch "APPLE", "TESLA", etc.
  const isDirectTicker = /^[A-Z]{1,4}$/.test(upperRaw) && raw === raw.toUpperCase();
  let ticker;

  if (isDirectTicker) {
    ticker = upperRaw;
  } else {
    // Show searching state
    const btn = document.getElementById('analyzeBtn');
    const origLabel = btn.innerHTML;
    btn.innerHTML = '<span class="spinner"></span>Searching...';
    btn.disabled = true;
    try {
      const searchRes  = await fetch(`https://financialmodelingprep.com/api/v3/search?query=${encodeURIComponent(raw)}&limit=10&exchange=NASDAQ,NYSE,AMEX&apikey=${FMP_KEY}`);
      const searchData = await searchRes.json();
      const results    = Array.isArray(searchData) ? searchData : (searchData?.data || []);
      // Prefer US exchanges
      const match = results.find(r => ['NASDAQ','NYSE','AMEX','NYSE ARCA'].includes(r.exchangeShortName || r.stockExchange))
                 || results[0];
      if (!match?.symbol) {
        showError(`No stock found for "${raw}". Try the ticker symbol (e.g. AAPL).`);
        btn.innerHTML = origLabel;
        btn.disabled  = false;
        return;
      }
      ticker = match.symbol.toUpperCase();
      input.value = ticker; // Show resolved ticker in the box
    } catch(e) {
      showError('Search failed. Please enter a ticker symbol directly.');
      btn.innerHTML = origLabel;
      btn.disabled  = false;
      return;
    }
  }
  document.getElementById('verdict').className = 'verdict';
  document.getElementById('stockInfo').className = 'stock-info';

  const btn = document.getElementById('analyzeBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>Analyzing...';

  renderSkeletons();

  try {
    const [dailyData, weeklyData, fmpData] = await Promise.all([
      fetchYahoo(ticker),
      fetchWeeklyChart(ticker),
      fetchFMPFundamentals(ticker)
    ]);

    // --- Parse daily chart ---
    const chartResult = dailyData.chart?.chart?.result?.[0];
    if (!chartResult) throw new Error(`Ticker "${ticker}" not found`);

    const closes = chartResult.indicators.quote[0].close.filter(v => v != null);
    const currentPrice = closes[closes.length - 1];
    const prevPrice = closes[closes.length - 2];
    const change = ((currentPrice - prevPrice) / prevPrice * 100);

    // Stock info bar
    const meta = chartResult.meta;
    const name = meta.symbol;
    document.getElementById('stockName').textContent = name;
    document.getElementById('stockPrice').textContent = `$${currentPrice.toFixed(2)}`;
    const changeEl = document.getElementById('stockChange');
    changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
    changeEl.className = `stock-change ${change >= 0 ? 'up' : 'down'}`;
    document.getElementById('stockInfo').className = 'stock-info visible';

    // --- CHECK 1: 200-day MA ---
    const ma200d = calcSMA(closes, 200);
    const pass1 = ma200d !== null && currentPrice <= ma200d;
    updateCard('ma200d', pass1,
      ma200d
        ? `Price: <span class="${pass1 ? 'pass-val' : 'fail-val'}">$${currentPrice.toFixed(2)}</span> ¬∑ 200D MA: <span class="val">$${ma200d.toFixed(2)}</span> ¬∑ ${pass1 ? 'Price is BELOW MA ‚Äî potential value zone' : 'Price is ABOVE MA ‚Äî not yet at support'}`
        : 'Insufficient data for 200-day MA'
    );

    // --- CHECK 2: RSI ---
    const rsi = calcRSI(closes, 14);
    const pass2 = rsi !== null && rsi <= 30;
    updateCard('rsi30', pass2,
      rsi
        ? `RSI(14): <span class="${pass2 ? 'pass-val' : 'fail-val'}">${rsi.toFixed(1)}</span> ¬∑ ${pass2 ? 'OVERSOLD ‚Äî historically a strong buy signal' : rsi <= 40 ? 'Approaching oversold territory' : 'Not oversold yet'}`
        : 'Insufficient data for RSI'
    );

    // --- CHECK 3: Balance Sheet ---
    // --- CHECK 3: Balance Sheet via FMP ---
    let pass3 = false;
    let balanceDetail = 'Could not fetch fundamental data. Check your FMP API key.';

    if (fmpData?.income?.length > 0 && fmpData?.bs?.length > 0) {
      const inc  = fmpData.income[0];
      const inc1 = fmpData.income[1];
      const bs   = fmpData.bs[0];

      const netMargin = inc.revenue > 0 ? inc.netIncome / inc.revenue : null;
      const totalCash = (bs.cashAndCashEquivalents || 0) + (bs.shortTermInvestments || 0);
      const totalDebt = bs.totalDebt || bs.longTermDebt || 0;
      const revGrowth = inc1 && inc1.revenue > 0 ? (inc.revenue - inc1.revenue) / inc1.revenue : null;

      const hasMargin  = netMargin != null && netMargin > 0;
      const canPayDebt = totalDebt === 0 ? true : (totalCash >= totalDebt * 0.5);
      pass3 = hasMargin && canPayDebt;

      const marginStr = netMargin != null ? `${(netMargin * 100).toFixed(1)}%` : 'N/A';
      const cashStr   = `$${(totalCash / 1e9).toFixed(2)}B`;
      const debtStr   = `$${(totalDebt / 1e9).toFixed(2)}B`;
      const ratio     = totalDebt > 0 ? (totalCash / totalDebt).toFixed(2) + 'x' : 'Debt-free ‚úì';
      const revStr    = revGrowth != null ? ` ¬∑ Rev Growth: <span class="${revGrowth > 0 ? 'pass-val' : 'fail-val'}">${(revGrowth*100).toFixed(1)}%</span>` : '';

      const sourceTag = fmpData.source ? ` ¬∑ <span style="color:var(--muted);font-size:10px">${fmpData.source}</span>` : '';
      balanceDetail = `Net Margin: <span class="${hasMargin ? 'pass-val' : 'fail-val'}">${marginStr}</span> ¬∑ Cash: <span class="val">${cashStr}</span> ¬∑ Debt: <span class="val">${debtStr}</span> ¬∑ Cash/Debt: <span class="${canPayDebt ? 'pass-val' : 'fail-val'}">${ratio}</span>${revStr}${sourceTag}`;
    }

    updateCard('balance', pass3, balanceDetail);

    // --- CHECK 4: 200-week MA ---
    const weeklyResult = weeklyData?.chart?.result?.[0];
    let pass4 = false;
    let weeklyDetail = 'Insufficient weekly data';

    if (weeklyResult) {
      const weeklyCloses = weeklyResult.indicators.quote[0].close.filter(v => v != null);
      const ma200w = calcSMA(weeklyCloses, 200);
      pass4 = ma200w !== null && currentPrice <= ma200w;
      weeklyDetail = ma200w
        ? `Price: <span class="${pass4 ? 'pass-val' : 'fail-val'}">$${currentPrice.toFixed(2)}</span> ¬∑ 200W MA: <span class="val">$${ma200w.toFixed(2)}</span> ¬∑ ${pass4 ? 'Price is BELOW weekly MA ‚Äî long-term value zone' : 'Price is ABOVE weekly MA'}`
        : 'Need 200+ weeks of data for this check';
    }

    updateCard('ma200w', pass4, weeklyDetail);

    // --- Verdict ---
    const score = [pass1, pass2, pass3, pass4].filter(Boolean).length;
    document.getElementById('scoreVal').textContent = score;

    const verdictEl = document.getElementById('verdict');
    const verdictIcon = document.getElementById('verdictIcon');
    const verdictTitle = document.getElementById('verdictTitle');
    const verdictSub = document.getElementById('verdictSub');

    if (score === 4) {
      verdictEl.className = 'verdict bullish visible';
      verdictIcon.textContent = 'üéØ';
      verdictTitle.textContent = 'Strong Buy Signal ‚Äî All 4 Checks Pass';
      verdictSub.textContent = 'Technically oversold, fundamentally sound, and at long-term support. High-conviction entry zone.';
    } else if (score === 3) {
      verdictEl.className = 'verdict bullish visible';
      verdictIcon.textContent = 'üìà';
      verdictTitle.textContent = 'Bullish Setup ‚Äî 3 of 4 Checks Pass';
      verdictSub.textContent = 'Strong setup. Consider waiting for the remaining signal before entering.';
    } else if (score === 2) {
      verdictEl.className = 'verdict neutral visible';
      verdictIcon.textContent = '‚öñÔ∏è';
      verdictTitle.textContent = 'Mixed Signals ‚Äî 2 of 4 Checks Pass';
      verdictSub.textContent = 'Some positive signals but not a high-conviction setup. Watch for further confirmation.';
    } else if (score === 1) {
      verdictEl.className = 'verdict bearish visible';
      verdictIcon.textContent = '‚ö†Ô∏è';
      verdictTitle.textContent = 'Weak Setup ‚Äî Only 1 Check Passes';
      verdictSub.textContent = 'Most signals are not favorable. Not an ideal entry point based on your criteria.';
    } else {
      verdictEl.className = 'verdict bearish visible';
      verdictIcon.textContent = 'üö´';
      verdictTitle.textContent = 'No Buy Signal ‚Äî 0 of 4 Checks Pass';
      verdictSub.textContent = 'Stock does not meet any of your entry criteria. Wait for a better setup.';
    }

    // Update Twitter buttons
    const fgSentiment = document.getElementById('fgSentiment')?.textContent || 'Unknown';
    updateTwitterButtons(ticker, currentPrice.toFixed(2), score, fgSentiment);

    // Update profile stats
    updateStats(score);

    // Show add to watchlist button
    let wlBtn = document.getElementById('addWlBtn');
    if (!wlBtn) {
      wlBtn = document.createElement('button');
      wlBtn.id = 'addWlBtn';
      wlBtn.className = 'add-watchlist-btn';
      document.getElementById('verdict').after(wlBtn);
    }
    wlBtn.textContent = `‚≠ê Add ${ticker} to Watchlist`;
    wlBtn.style.display = 'block';
    wlBtn.onclick = () => addToWatchlist(ticker, currentPrice.toFixed(2), score);

  } catch (err) {
    document.getElementById('checksContainer').innerHTML = '';
    showError(`Error: ${err.message}. Check the ticker symbol and try again.`);
  }

  btn.disabled = false;
  btn.innerHTML = 'Analyze';
}

// ‚îÄ‚îÄ TAB NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const mainContent = ['header','fgWidget','search-wrap-id','stockInfo','checksContainer','verdict','twitterBtns','add-wl-btn'];

function showTab(tab) {
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(`nav-${tab}`).classList.add('active');

  const isHome = tab === 'home';

  // Single scanner wrapper - show/hide everything at once
  document.getElementById('scannerPage').style.display    = isHome ? '' : 'none';
  document.querySelector('.header').style.display         = isHome ? 'block' : 'none';
  document.querySelector('.search-wrap').style.display    = isHome ? '' : 'none';
  document.getElementById('errorMsg').style.display       = 'none';

  // Tab panels
  document.getElementById('tab-watchlist').style.display = tab === 'watchlist' ? '' : 'none';
  document.getElementById('tab-profile').style.display   = tab === 'profile'   ? '' : 'none';
  document.getElementById('tab-options').style.display   = tab === 'options'   ? '' : 'none';

  if (tab === 'watchlist') renderWatchlist();
  if (tab === 'profile')   renderProfile();
}

// ‚îÄ‚îÄ WATCHLIST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let watchlist = JSON.parse(localStorage.getItem('wl') || '[]');

function addToWatchlist(ticker, price, score) {
  if (watchlist.find(w => w.ticker === ticker)) {
    alert(`${ticker} is already in your watchlist!`);
    return;
  }
  watchlist.push({ ticker, price, score, added: new Date().toLocaleDateString() });
  localStorage.setItem('wl', JSON.stringify(watchlist));
  updateStats();
  alert(`${ticker} added to watchlist!`);
}

function removeFromWatchlist(ticker) {
  watchlist = watchlist.filter(w => w.ticker !== ticker);
  localStorage.setItem('wl', JSON.stringify(watchlist));
  renderWatchlist();
  updateStats();
}

function renderWatchlist() {
  const container = document.getElementById('watchlistItems');
  const empty     = document.getElementById('watchlistEmpty');
  if (watchlist.length === 0) {
    empty.style.display     = '';
    container.innerHTML     = '';
    return;
  }
  empty.style.display = 'none';
  container.innerHTML = watchlist.map(w => `
    <div class="watchlist-item" onclick="loadTicker('${w.ticker}')">
      <div class="wl-left">
        <div class="wl-ticker">${w.ticker}</div>
        <div class="wl-price">$${w.price}</div>
        <div class="wl-score ${w.score >= 3 ? 'high' : w.score >= 2 ? 'mid' : 'low'}">${w.score}/4</div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;">
        <span style="font-size:11px;color:var(--muted);">${w.added}</span>
        <button class="wl-bell ${w.alertThreshold ? 'bell-on' : ''}" 
          onclick="event.stopPropagation();toggleAlert('${w.ticker}')" 
          title="${w.alertThreshold ? 'Alert: ' + w.alertThreshold + '/4 setup ‚Äî click to change' : 'Set score alert'}">
          ${w.alertThreshold ? 'üîî' : 'üîï'}
        </button>
        ${w.alertThreshold ? `<span class="alert-badge">${w.alertThreshold}/4</span>` : ''}
        <button class="wl-remove" onclick="event.stopPropagation();removeFromWatchlist('${w.ticker}')">‚úï</button>
      </div>
    </div>
  `).join('');
}

function loadTicker(ticker) {
  showTab('home');
  document.getElementById('tickerInput').value = ticker;
  analyze();
}

function toggleAlert(ticker) {
  const item = watchlist.find(w => w.ticker === ticker);
  if (!item) return;

  // Show modal
  document.getElementById('alertModal').style.display = 'flex';
  document.getElementById('alertModalTicker').textContent = ticker;
  document.getElementById('alertModal').dataset.ticker = ticker;

  // Pre-select current threshold
  document.querySelectorAll('.alert-option').forEach(btn => {
    btn.classList.toggle('selected', btn.dataset.val === String(item.alertThreshold || ''));
  });
}

function setAlertThreshold(val) {
  const ticker = document.getElementById('alertModal').dataset.ticker;
  const item   = watchlist.find(w => w.ticker === ticker);
  if (!item) return;

  if (val === 'off') {
    item.alertThreshold = null;
  } else {
    item.alertThreshold = parseInt(val);
  }

  localStorage.setItem('wl', JSON.stringify(watchlist));
  closeAlertModal();
  renderWatchlist();

  if (val !== 'off') {
    showToast(`üîî Alert set for ${ticker}: notify when score reaches ${val}/4`);
  } else {
    showToast(`üîï Alert removed for ${ticker}`);
  }
}

function closeAlertModal() {
  document.getElementById('alertModal').style.display = 'none';
}

function showToast(msg) {
  let t = document.getElementById('toast');
  if (!t) {
    t = document.createElement('div');
    t.id = 'toast';
    document.body.appendChild(t);
  }
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

// ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let stats = JSON.parse(localStorage.getItem('stats') || '{"scanned":0,"passed":0}');

function updateStats(score) {
  if (score !== undefined) {
    stats.scanned++;
    if (score >= 3) stats.passed++;
    localStorage.setItem('stats', JSON.stringify(stats));
  }
  document.getElementById('statScanned').textContent   = stats.scanned  || 0;
  document.getElementById('statWatchlist').textContent = watchlist.length;
  document.getElementById('statPassed').textContent    = stats.passed   || 0;
}

function renderProfile() {
  const name  = localStorage.getItem('profileName')  || 'Investor';
  const email = localStorage.getItem('profileEmail') || '';
  document.getElementById('profileName').textContent = name;
  document.getElementById('nameInput').value         = name !== 'Investor' ? name : '';
  document.getElementById('emailInput').value        = email;
  document.getElementById('passInput').value         = '';
  updateStats();
}

function saveProfile() {
  const name  = document.getElementById('nameInput').value.trim();
  const email = document.getElementById('emailInput').value.trim();
  const pass  = document.getElementById('passInput').value.trim();
  if (name)  { localStorage.setItem('profileName',  name);  document.getElementById('profileName').textContent = name; }
  if (email) { localStorage.setItem('profileEmail', email); }
  if (pass)  { localStorage.setItem('profilePass',  btoa(pass)); }
  alert('Profile saved!');
}

// ‚îÄ‚îÄ TWITTER BUTTONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateTwitterButtons(ticker, price, score, sentiment) {
  const tweetText = encodeURIComponent(
    `$${ticker} Health Check: ${score}/4 signals ‚úÖ\n` +
    `Price: $${price} | Market: ${sentiment}\n` +
    `Analyzed with Leap Scanner üìä`
  );
  document.getElementById('tweetShareBtn').href  = `https://twitter.com/intent/tweet?text=${tweetText}`;
  document.getElementById('tweetSearchBtn').href = `https://twitter.com/search?q=%24${ticker}`;
  document.getElementById('tweetSearchBtn').innerHTML = `üîç View $${ticker} on X`;
  const twDiv = document.getElementById('twitterBtns');
  twDiv.style.cssText = 'display:flex; margin-top:16px; gap:10px; justify-content:center; flex-wrap:wrap;';
}

// Enter key support
document.getElementById('tickerInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') analyze();
});


/* ‚îÄ‚îÄ OPTIONS CHAIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

let optCurrentTicker = '';
let optCurrentSide   = 'calls';
let optChainData     = {};  // { expDate: { calls: [...], puts: [...] } }
let optStockPrice    = 0;

async function loadOptionsChain() {
  const ticker = document.getElementById('optTickerInput').value.trim().toUpperCase();
  if (!ticker) return;

  optCurrentTicker = ticker;
  optChainData = {};

  // Reset UI
  setOptLoading(true);
  setOptError('');
  document.getElementById('optExpWrap').style.display    = 'none';
  document.getElementById('optToggleWrap').style.display = 'none';
  document.getElementById('optPriceBar').style.display   = 'none';
  document.getElementById('optTableWrap').style.display  = 'none';

  try {
    // 1. Get current stock quote
    const quoteRes = await fetch(
      `https://sandbox.tradier.com/v1/markets/quotes?symbols=${ticker}&greeks=false`,
      { headers: { Authorization: `Bearer ${TRADIER_KEY}`, Accept: 'application/json' } }
    );
    const quoteJson = await quoteRes.json();
    const quote = quoteJson?.quotes?.quote;
    optStockPrice = parseFloat(quote?.last || quote?.close || 0);

    // 2. Get expirations
    const expRes = await fetch(
      `https://sandbox.tradier.com/v1/markets/options/expirations?symbol=${ticker}&includeAllRoots=false`,
      { headers: { Authorization: `Bearer ${TRADIER_KEY}`, Accept: 'application/json' } }
    );
    const expJson = await expRes.json();
    const expirations = expJson?.expirations?.date;

    if (!expirations || expirations.length === 0) {
      throw new Error(`No options found for ${ticker}`);
    }

    const expList = Array.isArray(expirations) ? expirations : [expirations];

    // Populate expiration selector
    const sel = document.getElementById('optExpSelect');
    sel.innerHTML = '';
    expList.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d;
      opt.textContent = formatExpDate(d);
      sel.appendChild(opt);
    });

    // Update price bar
    document.getElementById('optStockLabel').textContent = ticker;
    document.getElementById('optStockPrice').textContent = optStockPrice ? `$${optStockPrice.toFixed(2)}` : '';

    setOptLoading(false);
    document.getElementById('optExpWrap').style.display    = '';
    document.getElementById('optToggleWrap').style.display = '';
    document.getElementById('optPriceBar').style.display   = '';

    // Auto-load first expiration
    await loadStrikesByExp();

  } catch(e) {
    setOptLoading(false);
    setOptError(e.message || 'Failed to fetch options. Check your Tradier API key.');
  }
}

async function loadStrikesByExp() {
  const expDate = document.getElementById('optExpSelect').value;
  if (!expDate || !optCurrentTicker) return;

  // Check cache
  if (optChainData[expDate]) {
    renderChain(optChainData[expDate]);
    return;
  }

  setOptLoading(true);
  document.getElementById('optTableWrap').style.display = 'none';

  try {
    const res = await fetch(
      `https://sandbox.tradier.com/v1/markets/options/chains?symbol=${optCurrentTicker}&expiration=${expDate}&greeks=true`,
      { headers: { Authorization: `Bearer ${TRADIER_KEY}`, Accept: 'application/json' } }
    );
    const json = await res.json();
    const options = json?.options?.option;

    if (!options) throw new Error('No chain data returned');

    const chain = Array.isArray(options) ? options : [options];

    // Split into calls and puts, sort by strike
    const calls = chain.filter(o => o.option_type === 'call').sort((a,b) => a.strike - b.strike);
    const puts  = chain.filter(o => o.option_type === 'put').sort((a,b) => a.strike - b.strike);

    optChainData[expDate] = { calls, puts };
    setOptLoading(false);
    renderChain(optChainData[expDate]);

  } catch(e) {
    setOptLoading(false);
    setOptError(e.message || 'Failed to load chain for this expiration.');
  }
}

function renderChain(data) {
  const rows = optCurrentSide === 'calls' ? data.calls : data.puts;
  const tbody = document.getElementById('optTableBody');
  tbody.innerHTML = '';

  rows.forEach(opt => {
    const strike = parseFloat(opt.strike);
    const isITM  = optCurrentSide === 'calls' ? strike < optStockPrice : strike > optStockPrice;
    const greeks = opt.greeks || {};

    const delta = greeks.delta != null ? parseFloat(greeks.delta).toFixed(3) : '--';
    const theta = greeks.theta != null ? parseFloat(greeks.theta).toFixed(3) : '--';
    const iv    = opt.implied_volatility != null ? (parseFloat(opt.implied_volatility) * 100).toFixed(1) + '%' : '--';

    const deltaClass = Math.abs(delta) >= 0.6 ? 'delta-high'
                     : Math.abs(delta) >= 0.3 ? 'delta-mid' : 'delta-low';

    const tr = document.createElement('tr');
    if (isITM) tr.classList.add('itm-row');

    tr.innerHTML = `
      <td>
        <div class="strike-cell">
          $${strike.toFixed(0)}
          ${isITM ? '<span class="itm-badge">ITM</span>' : ''}
        </div>
      </td>
      <td>${fmt(opt.last)}</td>
      <td>${fmt(opt.bid)}</td>
      <td>${fmt(opt.ask)}</td>
      <td>${fmtInt(opt.volume)}</td>
      <td>${fmtInt(opt.open_interest)}</td>
      <td class="iv-val">${iv}</td>
      <td class="${deltaClass}">${delta}</td>
      <td class="theta-val">${theta}</td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById('optTableWrap').style.display = '';
}

function switchSide(side) {
  optCurrentSide = side;
  document.getElementById('toggleCalls').classList.toggle('active', side === 'calls');
  document.getElementById('togglePuts').classList.toggle('active',  side === 'puts');

  const expDate = document.getElementById('optExpSelect').value;
  if (expDate && optChainData[expDate]) {
    renderChain(optChainData[expDate]);
  }
}

function setOptLoading(show) {
  document.getElementById('optLoading').style.display = show ? '' : 'none';
}

function setOptError(msg) {
  const el = document.getElementById('optError');
  el.textContent = msg;
  el.style.display = msg ? '' : 'none';
}

function formatExpDate(d) {
  // d = "2025-01-17"
  const [y, m, day] = d.split('-');
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return `${months[parseInt(m)-1]} ${parseInt(day)}, ${y}`;
}

function fmt(v) {
  return v != null && v !== 0 ? `$${parseFloat(v).toFixed(2)}` : '--';
}

function fmtInt(v) {
  if (v == null) return '--';
  return parseInt(v).toLocaleString();
}

// Allow Enter key in options search
document.getElementById('optTickerInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') loadOptionsChain();
});

</script>
</body>
</html>
